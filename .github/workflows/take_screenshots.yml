name: Take screenshots and send to Telegram

on:
  push:
    branches:
      - master

jobs:
  take_screenshots:
    runs-on: ubuntu-latest
    steps:
      # Check out the repository
      - uses: actions/checkout@v2

      # Install the Flutter SDK
      - name: Install Flutter SDK
        uses: subosito/flutter-action@v1
        with:
          channel: stable

      # Get the list of supported devices
      - name: Get device list
        run: flutter devices

      # Take screenshots on each device
      - name: Take screenshots
        run: flutter drive --target=test_driver/screenshot.dart --driver-log-file=screenshots.log
        env:
          FLUTTER_DRIVER_USE_FIRST_DEVICE: true
          FLUTTER_DRIVER_NO_ANIMATIONS: true

      # Extract and decode the base64-encoded strings from the log file
      - name: Extract and decode screenshots
        run: |
          strings=$(grep 'screenshot:' screenshots.log | sed 's/screenshot: //')
          i=0
          for string in $strings; do
            base64 --decode <<< $string > screenshot-$i.png
            i=$((i+1))
          done

      # Create a new release
      - name: Create release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      # Upload the screenshots to the release
      - name: Upload screenshots
        uses: actions/upload-release-asset@
